<template>
  <div>
    <LoginDialog
      :is-opened.sync="isOpenedLoginDialog"
      @update="updateLoginUser"
    />
    <PostDetailDialog
      v-model="isOpenedPostDetailDialog"
      :post.sync="selectedPost"
      :loginUser="loginUser"
    />

    <CreatePostDialog
      v-model="isOpenedCreatePostDialog"
      @create="createPosts"
    />
    <v-app-bar fixed dark color="black">
      <v-row class="mx-10">
        <v-col class="text-h3 font-weight-bold"> O-gram </v-col>
        <v-col v-if="isLogined" class="d-flex">
          <v-spacer />
          <p
            class="mb-0 white--text text-body-1 font-weight-bold mr-4"
            style="line-height: 60px"
          >
            <v-icon>mdi-account-outline</v-icon>
            {{ loginUser.username }}
          </p>
          <v-btn
            class="d-block white--text text-body-1 font-weight-bold"
            text
            @click="logout"
          >
            <v-icon>mdi-logout</v-icon>
            ログアウト
          </v-btn>
          <!-- <p class="mb-0">{{ loginUser.username }}</p> -->
        </v-col>
        <v-col v-else class="d-flex">
          <v-spacer />
          <v-btn
            class="d-block white--text text-body-1 font-weight-bold mr-4"
            text
            @click="openLoginDialog"
          >
            <v-icon>mdi-login</v-icon>
            ログイン
          </v-btn>
          <v-btn
            class="d-block white--text text-body-1 font-weight-bold"
            text
            @click="openLoginDialog"
          >
            <v-icon>mdi-account-multiple-plus-outline</v-icon>
            新規登録
          </v-btn>
          <!-- <p class="mb-0">{{ loginUser.username }}</p> -->
        </v-col>
      </v-row>
    </v-app-bar>
    <div class="posts-wrapper">
      <v-btn
        tile
        class="d-block mx-auto font-weight-bold"
        width="600px"
        height="40px"
        @click="openCreatePostDialog"
      >
        <v-icon>mdi-plus</v-icon> 投稿を追加する
      </v-btn>
      <!--投稿 -------------------------------------------------------->
      <v-card
        v-for="(post, postIndex) in allPosts"
        :key="post.id"
        flat
        tile
        class="mx-auto pb-5 mt-5 mb-10"
        width="600"
      >
        <!-- プロフィール -->
        <v-row class="post-nav py-2 px-3 justify-space-between" no-gutters>
          <v-col class="d-flex align-center font-weight-bold">
            <div class="icon-wrapper">
              <img
                :src="ICONS[post.author.icon] || ICONS[0]"
                alt="アイコン"
                width="100%"
              />
            </div>
            <p class="mb-0 ml-2">{{ post.author.username }}</p>
          </v-col>
          <v-col align-self="center" class="text-right">
            <v-btn text icon @click="deletePost(post)"
              ><v-icon>mdi-dots-horizontal</v-icon></v-btn
            >
          </v-col>
        </v-row>
        <!-- 画像 -->
        <v-carousel delimiter-icon="mdi-circle-small" :continuous="false">
          <v-carousel-item
            v-for="(image, imageIndex) in postImages[postIndex]"
            :key="imageIndex"
          >
            <v-sheet height="100%" tile>
              <v-row class="fill-height" align="center" justify="center">
                <img :src="image" />
              </v-row>
            </v-sheet>
          </v-carousel-item>
        </v-carousel>
        <!-- アイコン -->
        <v-row class="post-icon-row px-3 justify-space-between" no-gutters>
          <v-col>
            <span>
              <v-btn
                text
                icon
                @click="togglePostLike(post)"
                :loading="isLoading"
              >
                <v-icon v-if="isLikedThePost(post)" color="red" large>
                  mdi-heart
                </v-icon>
                <v-icon v-else large>mdi-heart-outline</v-icon>
              </v-btn>
            </span>
            <v-btn text icon @click="openPostDetailDialog(post)">
              <v-icon large>mdi-chat-processing-outline</v-icon>
            </v-btn>
          </v-col>
          <v-col class="text-right">
            <v-btn text icon>
              <!-- <v-icon v-if="post.bookmarkFlag" large>mdi-bookmark</v-icon> -->
              <v-icon large>mdi-bookmark-outline</v-icon>
            </v-btn>
          </v-col>
        </v-row>
        <!-- いいね -->
        <v-row no-gutters class="px-4 text-body-2">
          <v-col>
            <span v-if="post.likes.items.length" class="font-weight-bold">
              {{ post.likes.items.length }}人
            </span>
            <span v-else class="font-weight-bold">0人</span>
            <span>が「いいね！」しました</span>
          </v-col>
        </v-row>
        <!-- 投稿テキスト -->
        <v-row no-gutters class="px-4">
          <p class="mb-0">
            <span class="font-weight-bold">{{ post.author.username }}</span>
            <span style="white-space: pre-wrap">{{ post.content }} </span>
          </p>
          <p class="mb-0"></p>
        </v-row>
        <v-row class="px-4" no-gutters>
          <v-btn
            v-if="post.comments.items.length"
            text
            @click="openPostDetailDialog(post)"
          >
            <p class="text-body-2 text--secondary mb-0">
              コメント{{ post.comments.items.length }}件をすべて見る
            </p>
          </v-btn>
          <p v-else class="text-body-2 text--secondary mb-0">コメントなし</p>
        </v-row>
      </v-card>
    </div>
  </div>
</template>

<script lang="ts">
import {
  computed,
  defineComponent,
  ref,
  useFetch,
  watch,
} from 'nuxt-composition-api'
import { listPostsGql } from '~/appsync/queries'
import { Storage } from 'aws-amplify'
import {
  deletePostLikeGql,
  deletePostGql,
  createPostLikeGql,
} from '../appsync/mutations'
import {
  CreatePostLikeInput,
  DeletePostLikeInput,
  Post,
  PostLike,
  User,
} from '~/types/schema'
const ICONS = [
  require('~/assets/image/icon/01.png'),
  require('~/assets/image/icon/02.png'),
  require('~/assets/image/icon/03.png'),
  require('~/assets/image/icon/04.png'),
  require('~/assets/image/icon/05.png'),
  require('~/assets/image/icon/06.png'),
  require('~/assets/image/icon/07.png'),
  require('~/assets/image/icon/08.png'),
  require('~/assets/image/icon/09.png'),
]
export default defineComponent({
  setup(_, { root }) {
    /** data ***********************************************************/
    const isOpenedLoginDialog = ref(false)
    const isOpenedPostDetailDialog = ref(false)
    const isOpenedCreatePostDialog = ref(false)
    const isLogined = ref(true)
    const isLikePost = ref(false)
    const isLoading = ref(false)
    const isMarkedPost = ref(false)
    const selectedPost = ref<Post>()
    const allPosts = ref<Post[]>([])
    const loginUser = computed(() => {
      return root.$store.state.user.loginUser
    })
    /** computed ***********************************************************/
    const postImages = ref<any>([])
    /** method ***********************************************************/
    const openLoginDialog = () => {
      isOpenedLoginDialog.value = true
    }
    const logout = () => {
      isLogined.value = false
    }

    const updateLoginUser = (user: User) => {
      if (!user) return
      isLogined.value = true
    }

    const openPostDetailDialog = (post: Post) => {
      selectedPost.value = post
      console.debug(selectedPost.value)
      isOpenedPostDetailDialog.value = true
    }
    const openCreatePostDialog = (post: Post) => {
      isOpenedCreatePostDialog.value = true
    }

    const getPostImageList = async () => {
      const getPostImage = async (post: Post) => {
        const getOnePostImages = post.postImage.map(async (image) => {
          return await Storage.get(image)
        })
        return await Promise.all(getOnePostImages)
          .then((result) => {
            return result
          })
          .catch((e) => {
            console.error(e)
          })
      }

      for (const post in allPosts.value) {
        try {
          const images = await getPostImage(allPosts.value[post])
          postImages.value.push(images)
        } catch (e) {
          console.error(e)
        }
      }
      console.debug(postImages.value)
    }

    // 自分がいいねしているかのチェック
    const isLikedThePost = (post: Post) => {
      const likesItems = post.likes?.items
      const findItem = likesItems?.findIndex((item: PostLike) => {
        return item?.userId === loginUser.value?.id
      })
      return findItem !== -1
    }

    // postLikeのtoggle
    const togglePostLike = async (post: Post) => {
      isLoading.value = true
      if (isLikedThePost(post)) {
        const likesItems = post.likes.items
        const findItem = likesItems?.find((item: PostLike | null) => {
          return item?.userId === loginUser.value?.id
        })
        const input: DeletePostLikeInput = {
          id: findItem?.id!,
        }
        try {
          await deletePostLikeGql(input)
          allPosts.value = await listPostsGql()
        } catch (e) {
          console.error(e)
        }
      } else {
        const input: CreatePostLikeInput = {
          postId: post.id!,
          userId: loginUser.value?.id!,
        }
        try {
          await createPostLikeGql(input)
          allPosts.value = await listPostsGql()
        } catch (e) {
          console.error(e)
        }
      }
      isLoading.value = false
    }
    const createPosts = (post: Post) => {
      allPosts.value.push(post)
    }
    const deletePost = async (post: Post) => {
      try {
        const input = {
          id: post.id,
        }
        const deletedPost = await deletePostGql(input)
        console.debug(deletedPost)
        allPosts.value = await listPostsGql()
      } catch (e) {
        console.error(e)
      }
      console.debug(post)
    }
    /** init */
    watch(
      () => {
        allPosts.value
      },
      async () => {
        await getPostImageList()
      }
    )
    useFetch(async () => {
      try {
        const id = {
          id: 'cc41ac84-67e1-448c-ad0a-40624bc9144a',
        }
        await root.$store.dispatch('user/signIn', id)
        allPosts.value = await listPostsGql()
        await getPostImageList()
      } catch (e) {
        console.error(e)
      } finally {
        console.debug('allpost', allPosts.value)
        console.debug('loginUser', loginUser.value)
        console.debug('postImage', postImages.value)
      }
    })
    return {
      /** data */
      ICONS,
      loginUser,
      isOpenedLoginDialog,
      isOpenedPostDetailDialog,
      isOpenedCreatePostDialog,
      isLogined,
      isLikePost,
      isMarkedPost,
      selectedPost,
      allPosts,
      postImages,
      isLoading,
      /** computed */
      /** method */
      openLoginDialog,
      updateLoginUser,
      logout,
      openPostDetailDialog,
      openCreatePostDialog,
      togglePostLike,
      createPosts,
      isLikedThePost,
      deletePost,
    }
  },
})
</script>
<style scoped>
.v-card--flat {
  border: 1px solid #ddd;
}
.v-app-bar >>> .v-toolbar__content {
  max-width: 1000px;
  margin: 0 auto;
}
.posts-wrapper {
  margin-top: 100px;
}
.icon-wrapper {
  width: 50px;
  height: 50px;
  border: 1px solid #ddd;
  border-radius: 50%;
  overflow: hidden;
}
/* カルーセル */
.v-window.v-carousel {
  overflow: visible;
}
.v-carousel >>> .v-carousel__controls {
  background: none;
  height: 20px;
  transform: translateY(20px);
}
.v-carousel >>> .v-btn--icon.v-size--small {
  width: 15px;
  height: 10px;
  margin: 0;
  pointer-events: none;
}
.v-carousel >>> .v-carousel__controls .v-btn--icon .v-icon {
  transform: scale(2.5);
  color: #ccc;
  opacity: 1;
}
.v-carousel >>> .v-btn--icon.v-btn--active .v-icon {
  color: #0095f6;
}
.post-icon-row >>> .v-btn--icon {
  z-index: 2;
}
.v-btn:not(.v-btn--round).v-size--default {
  padding: 0;
  min-width: 0;
  height: auto;
}
.v-btn.white--text:hover {
  transition: 0.3s;
  background-color: rgb(61, 61, 61);
}
.v-btn.theme--light.v-btn.v-btn--has-bg {
  background-color: #fff;
}
</style>
